"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const schematics_1 = require("@angular-devkit/schematics");
const workspace_1 = require("@nrwl/workspace");
const utils_1 = require("../../utils");
const normalize_options_nx_1 = require("../../utils/normalize-options-nx");
const update_index_html_1 = require("../../utils/update-index-html");
function default_1(options) {
    return (tree, context) => {
        if (!utils_1.isNx(tree)) {
            context.logger.fatal('Schematics is not invoked inside of a Nx workspace. Please try again in a Nx workspace.');
            return;
        }
        const normalizedOptions = normalize_options_nx_1.normalizeOptionsNx(options, tree, context);
        return schematics_1.chain([
            addDependenciesToPackageJson(normalizedOptions.dependencies),
            utils_1.addConfigFiles(normalizedOptions),
            utils_1.updateWorkspaceTargets(normalizedOptions.projectName, workspace_1.updateWorkspace),
            utils_1.updateProjectRootStyles(normalizedOptions.projectName, workspace_1.getWorkspace, workspace_1.InsertChange),
            update_index_html_1.updateIndexHtml(normalizedOptions.projectName, normalizedOptions.darkMode, workspace_1.updateWorkspace),
        ])(tree, context);
    };
}
exports.default = default_1;
function addDependenciesToPackageJson(dependencies) {
    return (tree, ctx) => tslib_1.__awaiter(this, void 0, void 0, function* () {
        const devDeps = (yield Promise.all(dependencies.map((dep) => utils_1.getLatestNodeVersion(dep).then(({ name, version }) => {
            ctx.logger.info(`✅️ Added ${name}@${version}`);
            return { name, version };
        })))).reduce((result, { name, version }) => {
            result[name] = version;
            return result;
        }, {});
        return workspace_1.addDepsToPackageJson({}, devDeps)(tree, ctx);
    });
}
//# sourceMappingURL=nx-setup.js.map